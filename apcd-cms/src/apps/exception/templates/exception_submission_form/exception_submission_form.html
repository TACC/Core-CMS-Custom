{% extends "standard.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'exception/css/submission_form.css' %}">

<div class="container">
  {% include "nav_cms_breadcrumbs.html" %}



  <div class="row">
    <div class="col">
      <h1>Exception Request Form</h1>
      <hr />

      <p style="margin-bottom: 30px">
        This form should be completed and submitted only by entities who are
        eligible for an exception to certain data submission requirements under H.B. 2090 (87(R))
        and associated regulations. Please review the legislation and regulation before
        submitting this form. Links to both can be found on the
        <a href="https://sph.uth.edu/research/centers/chcd/apcd/"
          target="_blank">Texas All-Payor Claims Database website.</a> 
      </p>

      <hr />

      <div class="forms">

        <div class="form-wrapper">
          <form action="" method="POST">
            {% csrf_token %}
            <div class="form-errors" style="display: none"></div>

        </div>
      </div>
      <div class="description">
        <h4>
          Entity Being Registered
          <small>
            (Fill in all that apply.)
          </small>
        </h4>
      </div>
      <div class="field-wrapper required">
        <label>Number/Code<span class="asterisk">*</span>
        </label>
        <div class="help-text">
          Provide all available identifiers. At least one of the following
          is required.
        </div>
      </div>

      <div class="o-grid o-grid--col-auto-count">
        <div class="field-wrapper textinput">
          <div class="field-errors" style="display: none"></div>

          <label for="fein"> FEIN<sup>1</sup> </label>

          <input type="text" name="fein" placeholder="12-3456789" class="textinput" id="fein" inputmode="numeric"
            minlength="10" maxlength="10" pattern="\d{2}-\d{7}" required />

          <div id="help-text-fein" class="help-text">
            Enter in format <samp>12-3456789</samp>.
          </div>
        </div>
        <div class="field-wrapper textinput">
          <div class="field-errors" style="display: none"></div>

          <label for="license_number"> License Number </label>

          <input type="text" name="license_number" placeholder="1234567890" class="textinput" id="license_number"
            inputmode="numeric" minlength="5" maxlength="10" pattern="\d{5}|\d{10}" required />

          <div id="help-text-license_number" class="help-text">
            Enter a 5 or 10 digit number.
          </div>
        </div>
        <div class="field-wrapper textinput">
          <div class="field-errors" style="display: none"></div>

          <label for="naic_company_code"> NAIC<sup>2</sup> Company Code </label>

          <input type="text" name="naic_company_code" placeholder="12345" class="textinput" id="naic_company_code"
            inputmode="numeric" minlength="5" maxlength="5" pattern="\d+" required />

          <div id="help-text-naic_company_code" class="help-text">
            Enter a 5 digit number.
          </div>
        </div>
      </div>
      <hr />
      <h4>Exception Information</h4>
      <div id="exception_block_1">
        <div class="field-wrapper radioselect required">
          <div class="field-errors" style="display: none"></div>

          <label for="exception_type">
            Exception Type<span class="asterisk">*</span>
          </label>
          <ul id="exception-type" class="radioselect">
            <li>
              <label for="exception-type_0"><input type="radio" name="exception-type" value="true" class="radioselect"
                  required id="on-behalf-of_0" />
                Exception from a requirement under the regulations. </label>
            </li>

            <li>
              <label for="exception-type_1"><input type="radio" name="exception-type" value="true" class="radioselect"
                  required id="on-behalf-of_0" />
                Partial exception from select submission requirements. </label>
            </li>
          </ul>
        </div>

          <div class="field-wrapper numberinput required">
              <div class="field-errors" style="display: none"></div>

              <label for="exception_start_date">Start Date<span class="asterisk">*</span>
              </label>

              <input type="date" name="exception_start_date" class="numeric" id="exception_start_date"
                inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}" required />
          </div>
          <div>
            <div class="field-wrapper numberinput required">
              <div class="field-errors" style="display: none"></div>

              <label>End Date<sup>*</sup><span class="asterisk">*</span> </label>

              <input type="date" name="exception_end_date" class="numeric" id="exception_end_date"
                inputmode="numeric" pattern="\d{4}-\d{2}-\d{2}" required />
              </div>
            </div>
          </div>
        </div>

      </div>
      <h4 id="exception_header_2" style="display:none">Exception Information 2</h4>
      <div id="exception_block_2"></div>
      <h4 id="exception_header_3" style="display:none">Exception Information 3</h4>
      <div id="exception_block_3"></div>
      <h4 id="exception_header_4" style="display:none">Exception Information 4</h4>
      <div id="exception_block_4"></div>
      <h4 id="exception_header_5" style="display:none">Exception Information 5</h4>
      <div id="exception_block_5"></div>
      <button class="c-button c-button--primary" id="exception-add-btn" type="button">+ Add Another Exception Request
      </button>
      <button class="c-button c-button--secondary" id="exception-drop-btn" type="button">- Remove Last Exception
        Request</button>


      <hr />

      <h4>Justification</h4>
          <p>Provide rationale for the exception request, outlining the reasons why the organization is unable to
            comply with the relevant requirements. Provide as much detail as possible regarding the exception request, indicating the
            specific submission requirements for which relief is being sought. If applicable, indicate how the organization
            plans to become compliant.<sup>**</sup></p>
      <div class="field-wrapper textarea required">
        <div class="field-errors" style="display: none"></div>

        <textarea name="justification" cols="40" rows="10" class="textinput" type="justification"
          id="justification"></textarea>
        <p><span class="asterisk">*</span></p>
      </div>

      <hr />
      <div class="description">
        <h4>Acknowledgment of Terms</h4>
      </div>
      <div class="field-wrapper textinput required"><label>
          I request an exception on behalf of:
        </label></div>

      <div class="field-wrapper textinput required">
        <label for="business-name">
          Business Name<span class="asterisk">*</span>
        </label>
        <div class="field-errors" style="display: none"></div>

        <input type="text" name="business-name" required class="textinput" id="business-name" />
      </div>

      <div class="field-wrapper checkbox required">
        <div class="field-errors" style="display: none"></div>
        <label for="on-behalf-of_0"> I understand and acknowledge that the Texas Department
          of Insurance (TDI) may review the validity of the
          information submitted on this form.</label>
            <label for="on-behalf-of_0"><input type="checkbox" name="on-behalf-of" value="true" class="checkbox"
                required id="on-behalf-of_0" />
              Accept<span class="asterisk">*</span></label>


          <div class="button-wrapper submit">
            <button class="form-button" type="submit" value="Submit">
              Submit
            </button>
          </div>
          </form>
        <div class="form-success" style="display: none">
          <p>Thank you for your request.</p>
        </div>
      </div>

  {# Hidden links for future pages #}
  {# TODO: Allow this template to render CMS admin-entered markup #}
    <aside class="row" hidden>
      <div class="col col-12 col-sm-12 col-md-2 col-lg-2 col-xl-2">
        <p style="margin-top: 30px"><a href="/forms/register">Register</a></p>

        <p><a href="/forms/exception">Exception Request</a></p>

        <p><a href="/forms/extension">Extension Request</a></p>

        <p><a href="/workbench/dashboard">Dashboard</a></p>
      </div>
    </aside>

  {# Scripts #}
  {# WARNING: Many are cruft that created this now-static markup, but not all #}{# TODO: FP-1888: Clean out the cruft #}
  <aside>
    <!-- To let user add and remove entities -->
    {# RFE: Do not duplicate entity markup #}
    {# IDEA: HTML template for any instance; used by markup for 0, JS for 1+ #}
    <script id="form-add-remove-exception" type="module">
      const addExceptionBtn = document.getElementById("exception-add-btn");
      const dropExceptionBtn = document.getElementById("exception-drop-btn");
      const btnStatus = (() => {
        addExceptionBtn.disabled = ( exception == 5 ? true : false );
        dropExceptionBtn.disabled = ( exception == 1 ? true : false );
      });
      let exception = 1;
      btnStatus();

      addExceptionBtn.addEventListener("click", () => {
        if (exception < 5) exception += 1;
        let exceptionBlock = document.getElementById(`exception_block_${exception}`);
        document.getElementById(`exception_header_${exception}`).style.display = 'block';
        exceptionBlock.innerHTML = `
        <div class="field-wrapper radioselect required">
          <div class="field-errors" style="display: none"></div>

          <label for="exception_type">
            Exception Type<span class="asterisk">*</span>
          </label>
          <ul id="exception-type" class="radioselect">
            <li>
              <label for="exception-type_0"><input type="radio" name="exception-type" value="true" class="radioselect"
                  required id="on-behalf-of_0" />
                Exception from a requirement under the regulations. </label>
            </li>

            <li>
              <label for="exception-type_1"><input type="radio" name="exception-type" value="true" class="radioselect"
                  required id="on-behalf-of_0" />
                Partial exception from select submission requirements. </label>
            </li>
          </ul>
        </div>

       
        <div class="field-wrapper numberinput required">
          <div class="field-errors" style="display: none"></div>

          <label for="exception_start_date_${exception}">Start Date<span class="asterisk">*</span> </label>

            <input
              type="date"
              name="exception_start_date_${exception}"
              class="numeric"
              id="exception_start_date_${exception}"
              inputmode="numeric"
              pattern="\d{4}-\d{2}-\d{2}"
              required
            />
          </div>
        </div>
        <div>
        <div class="field-wrapper numberinput required">
          <div class="field-errors" style="display: none"></div>

          <label for=exception_end_date_${exception}>End Date<span class="asterisk">*</span> </label>

          <input
            type="date"
            name="exception_end_date_${exception}"
            class="numeric"
            id="exception_end_date_${exception}"
            inputmode="numeric"
            pattern="\d{4}-\d{2}-\d{2}"
            required
          />
        </div>
      </div>
      `;
        const inputs = Array.from(
          document.querySelectorAll(`
            input[name=exception_type_${exception}],
            input[name=exception_start_date_${exception}],
            input[name=exception_end_date_${exception}],
          `)
        );
        const inputListener = e => {
          inputs.filter(i => i !== e.target)
                .forEach(i => (i.required = !e.target.value.length));
        };
        inputs.forEach(i => i.addEventListener('input', inputListener));
        btnStatus();
      });

      dropExceptionBtn.addEventListener("click", () => {
        document.getElementById(`exception_header_${exception}`).style.display = 'none';
        let exceptionBlock = document.getElementById(`exception_block_${exception}`);
        exceptionBlock.innerHTML = '';
        if (exception > 1) exception -= 1;
        btnStatus();
      });
    </script>

    <!-- To require at least one "entity" identifier value -->
    <script id="form-entity_id-required" type="module">
      const inputs = Array.from(
        document.querySelectorAll('input[name=fein], input[name=license_number], input[name=naic_company_code]')
      );
      const inputListener = e => {
        inputs.filter(i => i !== e.target)
              .forEach(i => (i.required = !e.target.value.length));
      };

      inputs.forEach(i => i.addEventListener('input', inputListener));
    </script>

    <!-- TODO To require exception is not longer than a year -->
    <script id="form-exception_length_less_than_year" type="module">
      const inputs = Array.from( 
        document.querySelectorAll('input[name=exception_start_date], input[name=exception_end_date]')
      );//stopped here
      const inputListener = e => {
        inputs.filter(i => i !== e.target)
              .forEach(i => (i.required = !e.target.value.length));
      };

      inputs.forEach(i => i.addEventListener('input', inputListener));
    </script>
  </aside>

  {# Footnotes #}
  <div class="o-section o-section--style-light">
    <hr />
      <small
        >¹ Federal Employer Identification Number (FEIN)<br />
        ² National Association of Insurance Commissioners (NAIC)<br />
        </small
      >
      <hr />
      <small>
    <sup>*</sup> Exceptions cannot be granted for periods longer than a year<br/>
    <sup>**</sup>Exceptions cannot be granted "from any requirement in insurance code Chapter 38"<br/>
    </small
  >
  </div>
  <hr />
</div>
{% endblock %}
