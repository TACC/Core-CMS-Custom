{% extends "standard.html" %}
{% load static %}

{% block content %}

<link rel="stylesheet" href="{% static 'forms/css/exception_submission_form.css' %}">

<div class="container">
  {% include "nav_cms_breadcrumbs.html" %}

  <div class="row">
    <div class="col">
      <h1>Threshold Exception Request</h1>
      <hr />

      <p>
        This form should be completed and submitted only by entities who are
        eligible for an exception to certain data submission requirements under H.B. 2090 (87(R))
        and associated regulations. Please review the legislation and regulation before
        submitting this form. Links to both can be found on the
        <a href="https://sph.uth.edu/research/centers/chcd/apcd/" target="_blank">Texas All-Payor Claims Database
          website.</a>
      </p>
      <div class="forms">

        <div class="form-wrapper">
          <form action="" method="POST" id="threshold-form">
            {% csrf_token %}
            <div class="form-errors" style="display: none"></div>
            <div class="exception-header-1">
              <hr />
              <h4>File Type</h4>
              <p>Select submission file type for your requested threshold reduction:

              </p>
            </div>
            <div class="field-wrapper select required">
              <div class="field-errors" style="display: none"></div>

              <label for="file_type">File Type <span class="asterisk">*</span></label>


              <select name="file_type" required="required" class="choicefield" id="file_type"
               value="none">
                <option value="">-- Choose File Type --</option>
                <option value="dc">Dental Claims</option>

                <option value="mc">
                  Medical Claims
                </option>

                <option value="me">
                  Member Eligibility
                </option>

                <option value="pc">
                  Pharmacy Claims
                </option>

                <option value="pv">
                  Provider
                </option>
              </select>
              <div id="help-text-file_type" class="help-text">You can only submit an exception for one file type per
                form submission.
              </div>
            </div>
            <hr />


            
              <h4>Requested Threshold Reduction</h4>
              <div id="exception_block_1">
              <div class="field-wrapper select required" >
                <div class="field-errors" style="display: none"></div>
                <label for="field-threshold-exception">Field Code <span class="asterisk">*</span></label>

                <select name="field-threshold-exception" required="required" class="choicefield" 
                id="field-threshold-exception">
                  <!-- Populates in script -->
                  <option class=dropdown-text value=''>-- Select a File Type Above First --</option>
                  <option class="dropdown-text" value={{cdl.field_list_code}}></option>
                </select>
              </div>
              <div class="o-grid o-grid--col-auto-count">
              <div class="field-wrapper numberinput required">
                <div class="field-errors" style="display: none"></div>

                <label name="date-row" for="expiration-date">Expiriation Date<sup>*</sup><span class="asterisk">*</span> </label>

                <input type="date" name="expiration-date" class="numeric" id="expiration-date" inputmode="numeric"
                  pattern="\d{4}-\d{2}-\d{2}" required />
              </div>
                

                <div class="field-wrapper numberinput required">
                  <div class="field-errors" style="display: none"></div>
                  <label name="date-row" for="threshold-requested">
                    Requested Threshold Percentage <span class="asterisk">*</span>
                  </label>
                  
                  <div class="s-affixed-input-wrapper">
                    <input type="number" name="threshold-requested" class="textinput" id="threshold-requested"
                      inputmode="numeric" min="0" max="99" required />
                    <span class="s-affixed-input-wrapper__suffix">%</span>
                  </div>
                  <!-- Populates in script-->
                  <div id="help-text-threshold-requested_1" class="help-text">
                  </div>
                </div>
              </div>
            </div>
            <h4 id="exception_header_2" style="display:none">Requested Threshold Reduction 2</h4>
              <div id="exception_block_2"></div>
            <h4 id="exception_header_3" style="display:none">Requested Threshold Reduction 3</h4>
              <div id="exception_block_3"></div>
            <h4 id="exception_header_4" style="display:none">Requested Threshold Reduction 4</h4>
              <div id="exception_block_4"></div>
            <h4 id="exception_header_5" style="display:none">Requested Threshold Reduction 5</h4>
              <div id="exception_block_5"></div>
            <button class="c-button c-button--primary" id="exception-add-btn" type="button">+ Add Another Threshold
              Exception </button>
            <button class="c-button c-button--secondary" id="exception-drop-btn" type="button">- Remove Last Threshold
              Exception</button>
            <hr />
            <h4>Justification</h4>
            <div class="field-wrapper textarea required">
              <p>Provide rationale for the exception request, outlining the reasons why the
                organization is unable to comply with the relevant requirements. Provide as
                much detail as possible regarding the exception request, indicating the
                specific submission requirements for which relief is being sought. If applicable,
                indicate how the organization plans to become compliant.<sup>**</sup><label for="justification"><span
                    class="asterisk" id="justification-asterisk">
                    *</span></label></p>

              <div class="field-errors" style="display: none"></div>

              <textarea name="justification" cols="40" rows="10" class="textinput" form="threshold-form"
                type="justification" id="justification" minlength="2" maxlength="2000" required></textarea>
              <div class="help-text">
                2000 character limit
              </div>
            </div>
            <hr />
            <h4>Acknowledgment of Terms</h4>
            <div class="o-grid o-grid--col-auto-count">
              <div class="field-wrapper textinput required">
                <label for="requestor-name">
                  Requestor Name<span class="asterisk">*</span>
                </label>
                <div class="field-errors" style="display: none"></div>

                <input type="text" name="requestor-name" required class="textinput" id="requestor-name" />
              </div>
              <div class="field-wrapper emailinput required">
                <label for="requestor-email">
                  Requestor Email<span class="asterisk">*</span>
                </label>
                <div class="field-errors" style="display: none"></div>

                <input type="email" name="requestor-email" required class="emailinput" autocomplete="email"
                  id="requestor-email" pattern="^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[a-z]{2,4}$" />
              </div>
            </div>
            <div class="field-wrapper textinput required"><label>
                I request an exception on behalf of:
              </label></div>

            <div class="field-wrapper textinput required">
              <label for="business-name">
                Business Name<span class="asterisk">*</span>
              </label>
              <div class="field-errors" style="display: none"></div>
              <select name='business-name' required='required' class="choicefield" id='business-name'>
                {% for submitter in submitters %}
                <option class="dropdown-text" value={{submitter.submitter_id}}>{{submitter.org_name}} - ID:
                  {{submitter.submitter_id}}</option>
                {% endfor %}
              </select>

            </div>

            <div class="field-wrapper checkbox required">
              <div class="field-errors" style="display: none"></div>
              <label for="accept-terms"> I understand and acknowledge that the Texas Department
                of Insurance (TDI) may review the validity of the
                information submitted on this form.</label>
              <label for="accept-terms"><input type="checkbox" name="accept-terms" value="true" class="checkbox"
                  required id="accept-terms" />
                Accept<span class="asterisk">*</span></label>
            </div>
            <div class="button-wrapper submit">
              <button class="form-button" type="submit" value="Submit">
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
      <div class="form-success" style="display: none">
        <p>Thank you for your request.</p>
      </div>



      {# Hidden links for future pages #}
      {# TODO: Allow this template to render CMS admin-entered markup #}
      <aside class="row" hidden>
        <div class="col col-12 col-sm-12 col-md-2 col-lg-2 col-xl-2">
          <p style="margin-top: 30px"><a href="/forms/register">Register</a></p>

          <p><a href="/submissions/exception">Exception Request</a></p>

          <p><a href="/submissions/extension-request">Extension Request</a></p>

          <p><a href="/workbench/dashboard">Dashboard</a></p>
        </div>
      </aside>

      {# Scripts #}

      <aside>
        <!--To check for blank space only in text inputs #}-->
        <script src="{% static 'utils/js/checkForBlankInputs.js' %}"></script>
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        {# Adds blank space listener to all text input fields on page load #}
        <script>
          const formTextInputs = document.querySelectorAll('input[type=text], textarea');
          noEmptyInputs(formTextInputs);          
        </script> 
        <!-- To require exception is not longer than a year -->
        <script id="form-exception_length_less_than_year" type="module">
          $(function () {
            var dtToday = new Date();

            var month = dtToday.getMonth() + 1;
            var day = dtToday.getDate();
            var year = dtToday.getFullYear();
            if (month < 10)
              month = '0' + month.toString();
            if (day < 10)
              day = '0' + day.toString();

            var minDate = dtToday.toISOString().substr(0, 10);
            $('#expiration-date').attr('min', minDate);
            year = year + 1;
            var maxDate = year + '-' + month + '-' + day;
            $('#expiration-date').attr('max', maxDate);
          });
        </script>
        <script>
          function changeDropDownValues(value) {
            if (value.length == 0)
              fieldSelect = Array.of(document.querySelectorAll(`#field-threshold-exception_${exceptions}`))
              fieldSelect.forEach (element => {
                element.innerHTML = ""
          });
          };
          function btnStatus(exceptions) {            
            let addExceptionBtn = document.getElementById("exception-add-btn");
            let dropExceptionBtn = document.getElementById("exception-drop-btn");
            addExceptionBtn.disabled = (exceptions == 5 ? true : false);
            dropExceptionBtn.disabled = (exceptions == 1 ? true : false);
            console.log(exceptions + " In button status");
          };

          function addException(exceptions) {
            if (exceptions < 5) {
              exceptions += 1;
              let exceptionBlock = document.getElementById(`exception_block_${exceptions}`);
              document.getElementById(`exception_header_${exceptions}`).style.display = 'block';
              exceptionBlock.innerHTML = `
                <div class="field-wrapper select required" >
                  <div class="field-errors" style="display: none"></div>
                    <label for="field-threshold-exception_${exceptions}">Field Code <span class="asterisk">*</span></label>
                    <select name="field-threshold-exception_${exceptions}" required="required" class="choicefield" 
                    id="field-threshold-exception_${exceptions}">
                      <option class=dropdown-text value=''>-- Select a File Type Above First --</option>
                      <option class="dropdown-text" value={{cdl.field_list_code}}></option>
                    </select>
                </div>
                <div class="o-grid o-grid--col-auto-count">
                  <div class="field-wrapper numberinput required">
                    <div class="field-errors" style="display: none"></div>
                    <label for="expiration-date_${exceptions}">Expiriation Date<sup>*</sup><span class="asterisk">*</span> </label>
                    <input type="date" name="expiration-date_${exceptions}" class="numeric" id="expiration-date_${exceptions}" inputmode="numeric"
                      pattern="\d{4}-\d{2}-\d{2}" required />
                  </div>
                  <div class="field-wrapper numberinput required">
                    <div class="field-errors" style="display: none"></div>
                    <label for="threshold-requested_${exceptions}">
                      Requested Threshold Percentage <span class="asterisk">*</span>
                    </label>
                    <div class="s-affixed-input-wrapper">
                      <input type="number" name="threshold-requested_${exceptions}" class="textinput" id="threshold-requested_${exceptions}"
                        inputmode="numeric" min="0" max="99" required />
                      <span class="s-affixed-input-wrapper__suffix">%</span></div>
                    </div>
                    <!-- Populates in script-->
                    <div id="help-text-threshold-requested_${exceptions}" class="help-text">
                    </div>
                  </div>`
              };
              return exceptions
            };

          function removeException(exceptions) {
            if (exceptions > 1) {
              let exceptionBlock = document.getElementById(`exception_block_${exceptions}`);
              let exceptionHeader = document.getElementById(`exception_header_${exceptions}`);
  
              exceptionBlock.innerHTML = "";
              exceptionHeader.style.display = "none";
              exceptions = exceptions - 1;
            };
            return exceptions
          };
          // To fetch CDL codes on file type input change
          function getDynamicCDLData(file_type) {
            let cdls;
            let selectedFileType = file_type;
            $.ajax({
              url: "{% url 'exception:get-cdls' %}",
              type: 'GET',
              data: {
                'file_type': file_type
              },
              success: function(response) {
                cdls = response;
                if (selectedFileType != '') {
                  let dropDownHTML = `<option class='dropdown-text value=''>-- Select a Field Type --</option>`
                  for (let i = 0; i < cdls.length; i++) {
                    dropDownHTML = dropDownHTML + 
                    `<option class="dropdown-text" value="${cdls[i].field_list_code}">${cdls[i].field_list_value}: ${cdls[i].field_list_code}</option>`;
                  }
                  return dropDownHTML;
                }
              },
              error: function() {
                console.log("Error retrieving CDLs");
              }
            });
          };
          function getAllFieldDropDowns() {
            let fieldTypeSelect;
            fieldTypeSelect = Array.from(document.querySelectorAll('[id^="field-threshold-exception"]'));
            // Loop over each fieldTypeSelect element and clear
            for (let i = 0; i < fieldTypeSelect.length; i++) {
                fieldTypeSelect[i].innerHTML = "";
            };
            return fieldTypeSelect;
          };
          function getAllThresholdHelpTxt() {
            let helpThresholdText; 
            helpThresholdText =  Array.from(document.querySelectorAll('[id^="help-text-threshold-requested"]'));
            for (let i = 0; i < helpThresholdText.length; i++) {
                helpThresholdText[i].innerHTML = "";
            };
            return helpText;
          };

          $(document).ready(function() {
            let exceptions = 1;
            btnStatus(exceptions);
            let fileTypeSelect = $('#file_type').val();

            $('#exception-add-btn').click(function() {
              addException(exceptions);
              exceptions = addException(exceptions);
              btnStatus(exceptions);
              getDynamicCDLData(fileTypeSelect);
            });
            $('#exception-drop-btn').click(function() {
              removeException(exceptions);
              exceptions = removeException(exceptions);
              btnStatus(exceptions);
            });
            // addExceptionBtn.addEventListener("click", () => {
            //   if (exceptions < 5) exceptions += 1;
            //   let exceptionBlock = document.getElementById(`exception_block_${exceptions}`);
            //   document.getElementById(`exception_header_${exceptions}`).style.display = 'block';
            //   exceptionBlock.innerHTML = `
            //     <div class="field-wrapper select required" >
            //       <div class="field-errors" style="display: none"></div>
            //         <label for="field-threshold-exception_${exceptions}">Field Code <span class="asterisk">*</span></label>
            //         <select name="field-threshold-exception_${exceptions}" required="required" class="choicefield" 
            //         id="field-threshold-exception_${exceptions}">
            //           <option class=dropdown-text value=''>-- Select a File Type Above First --</option>

            //           <option class="dropdown-text" value={{cdl.field_list_code}}></option>
            //         </select>
            //     </div>
            //     <div class="o-grid o-grid--col-auto-count">
            //       <div class="field-wrapper numberinput required">
            //         <div class="field-errors" style="display: none"></div>
            //         <label for="expiration-date_${exceptions}">Expiriation Date<sup>*</sup><span class="asterisk">*</span> </label>
            //         <input type="date" name="expiration-date_${exceptions}" class="numeric" id="expiration-date_${exceptions}" inputmode="numeric"
            //           pattern="\d{4}-\d{2}-\d{2}" required />
            //       </div>
                  
            //     <div class="field-wrapper numberinput required">
            //       <div class="field-errors" style="display: none"></div>
            //       <label for="threshold-requested_${exceptions}">
            //         Requested Threshold Percentage <span class="asterisk">*</span>
            //       </label>
                  
            //       <div class="s-affixed-input-wrapper">
            //         <input type="number" name="threshold-requested_${exceptions}" class="textinput" id="threshold-requested_${exceptions}"
            //           inputmode="numeric" min="0" max="99" required />
            //         <span class="s-affixed-input-wrapper__suffix">%</span>
            //       </div>
            //         <!-- Populates in script-->
            //       <div id="help-text-threshold-requested_${exceptions}" class="help-text">
            //       </div>
            //     </div>
            //   </div>`
                    
          //     $('#file_type').change(function() {
          //     let file_type = $(this).val();
          //     let cdls;
          //     let helpText;
          //     let fieldTypeSelect;

          //     /*Clears help text when file type changes*/
          //     helpText = Array.from(document.querySelectorAll('[id^="help-text-threshold-requested"]'));
          //     fieldTypeSelect = Array.from(document.querySelectorAll('[id^="field-threshold-exception"]'));
          //     for (var i; i <= fieldTypeSelect.length; i++) {
          //       getAllFieldDropDowns(fieldTypeSelect[i])
          //     }
          //     for (var i; i <= fieldTypeSelect.length; i++) {
          //       getAllThresholdHelpTxt(fieldTypeSelect[i])
          //     }
          //     $.ajax({
          //       url: "{% url 'exception:get-cdls' %}",
          //       type: 'GET',
          //       data: {
          //         'file_type': file_type
          //       },
          //       success: function(response) {
          //         let cdls = response;
          //         if (file_type != '') {
          //           let dropDownHTML = `<option class='dropdown-text value=''>-- Select a Field Type --</option>`
          //           for (let i = 0; i < cdls.length; i++) {
          //             dropDownHTML = dropDownHTML + 
          //             `<option class="dropdown-text" value="${cdls[i].field_list_code}">${cdls[i].field_list_value}: ${cdls[i].field_list_code}</option>`;
                      
          //         }
          //         // Loop over each fieldTypeSelect element and set its innerHTML to the dropDownHTML
          //         for (let i = 0; i < fieldTypeSelect.length; i++) {
          //             fieldTypeSelect[i].innerHTML = "";
          //             fieldTypeSelect[i].innerHTML = dropDownHTML;

        
          //         //To change help text for requested threshold percentage
          //         fieldTypeSelect[i].addEventListener('change', function (event) {
          //           selectedFieldType = event.target.value;

          //             if (event.target.value != '') {
          //               for (let j = 0; j < cdls.length; j++)
          //                 if (event.target.value == cdls[j].field_list_code) {
          //                   for (let k = 0; k < helpText.length; k++)
          //                     if (helpText[i].id = `help-text-threshold-requested${exceptions}` ) {
          //                     helpText[i].innerHTML = "";
          //                     helpText[i].innerHTML = `Must be less than the ${cdls[j].threshold_value}% required.`
          //                 }
          //             }}})};
          //       }
          //       },
          //       error: function(xhr, status, error) {
          //         console.log(error);
          //       }
          //    });
          //   });
          });
        </script>
      </aside>

      {# Footnotes #}
      <div class="o-section o-section--style-light">
        <hr />
        <small>
          <sup>*</sup> Exceptions cannot be granted for periods longer than a year.<br />
          <sup>**</sup>Exceptions cannot be granted "from any requirement in insurance code Chapter 38".<br />
        </small>
        <hr />
      </div>
    </div>
  </div>
</div>
{% endblock %}